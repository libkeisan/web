var m=class{constructor(t){this.values=t}get year(){for(let t of this.values)if(t.type==="YEAR")return t.value;return null}get month(){for(let t of this.values)if(t.type==="MONTH")return t.value;return null}get day(){for(let t of this.values)if(t.type==="DAY")return t.value;return null}isValid(){if(![2,3].includes(this.values.length))return!1;let t,e,r;for(let s of this.values)switch(s.type){case"YEAR":if(t)return!1;t=s.value;break;case"MONTH":if(e)return!1;e=s.value;break;case"DAY":if(r)return!1;r=s.value;break}return!(e&&(e<1||e>12)||r&&(r<1||r>31))}countUnknowns(){let t=0;for(let e of this.values)e.type===null&&t++;return t}unknowns(t){for(let e of this.values)e.type===null&&t(e)}setFirstUnknown(t){for(let e of this.values)if(e.type===null){e.type=t;return}}complete(){if(this.isValid()&&this.countUnknowns()!==0&&!(this.countUnknowns()===2&&this.values.length===2)&&(this.year||this.unknowns(t=>{t.value>=1900&&t.value<=2100&&(t.type="YEAR")}),!this.day&&this.year!==null&&this.unknowns(t=>{t.value>12&&t.value<=31&&(t.type="DAY")}),this.countUnknowns()===1))if(this.values.length===3){if(this.year!==null&&this.month!==null){this.setFirstUnknown("DAY");return}if(this.year!==null&&this.day!==null){this.setFirstUnknown("MONTH");return}if(this.month!==null&&this.day!==null){this.setFirstUnknown("YEAR");return}}else if(this.year!=null&&this.day!=null){this.setFirstUnknown("MONTH");return}else this.month!=null&&(this.values.find(e=>e.type===null).value>31?this.setFirstUnknown("YEAR"):this.setFirstUnknown("DAY"))}getDateTime(){if(this.complete(),!this.isValid()||this.month==null)return null;let t=new Date,e=t.getTimezoneOffset()*-60,r=this.year||t.getFullYear(),s=this.month,u=this.day||1;return{timestamp:new Date(r,s-1,u).getTime(),offset:e}}};var O=n=>{let{value:t}=n[0],e=new Date().getTimezoneOffset()*-60,r=new Date,s=new Date(r);switch(s.setHours(0,0,0,0),t){case"now":return{timestamp:r.getTime(),offset:e};case"today":return{timestamp:s.getTime(),offset:e};case"tomorrow":return s.setDate(s.getDate()+1),{timestamp:s.getTime(),offset:e};case"yesterday":return s.setDate(s.getDate()-1),{timestamp:s.getTime(),offset:e}}return null},E=(n,t)=>{if(n.length==1&&n[0].type==="IDENT"){let u=O(n);return u?[{type:"DATETIME",value:u}]:null}let e=[];for(let u of n)if(u.type=="NUMBER"){let i=u.value;if(i.is_percent||i.value<0||i.value%1!==0)return null;e.push({value:parseInt(i.value),type:null})}else if(u.type=="IDENT"){let i=u.value.toLowerCase();if(t.era.includes(i)){if(e.length===0)return null;let l=e.length-1;if(e[l].type!==null)return null;e[l].type="YEAR",i==="bc"&&(e[l].value*=-1)}else if(t.suffix.includes(i)){if(e.length===0)return null;let l=e.length-1;if(e[l].type!==null)return null;e[l].type="DAY"}let o=0;for(let l=0;l<t.month.length;l++)if(t.month[l].startsWith(i)){o=l+1;break}o&&e.push({value:o,type:"MONTH"})}let s=new m(e).getDateTime();return s?[{type:"DATETIME",value:s}]:null},I=n=>{let t=-1,e=-1,r=-1,s=!1;for(let l of n)switch(l.type){case"NUMBER":let f=l.value;if(f.is_percent||f.value<0||f.value%1!==0)return null;if(t<0)t=f.value;else if(e<0)e=f.value;else if(r<0)r=f.value;else return null;break;case"IDENT":let p=l.value.toLowerCase();if(!["am","pm"].includes(p)||(t===12&&(t=0),t>12&&p==="am"))return null;t<12&&p==="pm"&&(t+=12),s=!0;break;case"COLON":break;default:return null}if(e<0&&s&&(e=0),t<0||e<0||(r<0&&(r=0),r>=60||e>=60||t>=24))return null;let u=new Date,i=u.getTimezoneOffset()*-60;return[{type:"DATETIME",value:{timestamp:new Date(u.getFullYear(),u.getMonth(),u.getDate(),t,e,r).getTime(),offset:i}}]},v=n=>{let t=({timestamp:f,offset:p})=>{let d=new Date(f+p*1e3);return d.getUTCHours()>0||d.getUTCMinutes()>0||d.getUTCSeconds()>0};if(n.length!==2||n[0].type!=="DATETIME"||n[1].type!=="DATETIME")return null;let e=n[0].value,r=n[1].value,s,u;if(t(e)&&t(r)||!t(e)&&!t(r))return null;t(e)?(s=r,u=e):(s=e,u=r);let i=new Date(s.timestamp+s.offset*1e3),o=new Date(u.timestamp+u.offset*1e3);i.setHours(o.getUTCHours(),o.getUTCMinutes(),o.getUTCSeconds(),0);let l=i.getTimezoneOffset()*-60;return[{type:"DATETIME",value:{timestamp:i.getTime(),offset:l}}]};var a={UNKNOWN:"UNKNOWN",SECOND:"SECOND",MINUTE:"MINUTE",HOUR:"HOUR",DAY:"DAY",WEEK:"WEEK",MONTH:"MONTH",YEAR:"YEAR"},N={[a.UNKNOWN]:0,[a.SECOND]:1,[a.MINUTE]:60,[a.HOUR]:3600,[a.DAY]:24*3600,[a.WEEK]:7*24*3600,[a.MONTH]:30*24*3600,[a.YEAR]:365*24*3600},T=n=>{let t=n.toLowerCase();return t.startsWith("s")?a.SECOND:t.startsWith("h")?a.HOUR:t.startsWith("d")?a.DAY:t.startsWith("w")?a.WEEK:t.startsWith("y")?a.YEAR:t.startsWith("mo")?a.MONTH:t.startsWith("m")?a.MINUTE:a.UNKNOWN},c=class n{constructor({value:t=0,unit:e=a.UNKNOWN,displayUnit:r=a.UNKNOWN}){this.value=t,this.unit=e,this.displayUnit=r}getSeconds(){return this.value*N[this.unit]}convert(t){if(t===a.UNKNOWN)return this;let e=this.getSeconds(),r=Math.floor(e/N[t]);return new n({value:r,unit:t,displayUnit:t})}breakdown(){if(!this.value)return[this];let t=[],e=this.getSeconds();for(let[r,s]of Object.entries(N).reverse()){if(!s)continue;let u=Math.floor(e/s);if(u&&(t.push(new n({value:u,unit:r})),e-=u*s),!e)break}return t}render(){let t=[];return this.displayUnit!=a.UNKNOWN?t.push(this.convert(this.displayUnit)):t=this.breakdown(),t.map(e=>`${e.value} ${e.unit}`).join(" ")}};var D=n=>{let t=[];for(let e of n)switch(e.type){case"NUMBER":let r=e.value;if(r.is_percent||r.value%1!==0)return null;t.push(new c({value:parseInt(r.value)}));break;case"IDENT":let s=T(e.value);if(s===a.UNKNOWN||t.length===0)return null;t[t.length-1].unit=s;break;case"KEYWORD":break;default:return null}return t.some(e=>e.unit===a.UNKNOWN)?null:t.map(e=>({type:"DURATION",value:e}))},U=n=>{let t=0;for(let u of n.slice(0,-1))switch(u.type){case"DURATION":let i=u.value;t+=i.getSeconds();break;case"KEYWORD":break;default:return null}let e=n[n.length-1];if(e.type!=="IDENT")return null;let r=T(e.value);return r===a.UNKNOWN?null:[{type:"DURATION",value:new c({value:t,unit:a.SECOND}).convert(r)}]},M=n=>{if(n.length!==3||n[1].type!=="MINUS")return null;let{timestamp:t}=n[0].value,{timestamp:e}=n[2].value,r=Math.floor((t-e)/1e3);return[{type:"DURATION",value:new c({value:r,unit:a.SECOND})}]},y=n=>{if(n.length<2||n[0].type!=="DATETIME")return null;let t=n[n.length-1];if(t.type==="DATETIME")return M(n);if(t.type!=="DURATION")return null;let e=0,r=2;switch(n[1].type){case"PLUS":e=1;break;case"MINUS":e=-1;break;case"DURATION":if(r=1,n[1].value.value>=0)return null;e=1;break;default:return null}if(e===0)return null;let s=n[0].value;for(let u of n.slice(r)){if(u.type!=="DURATION")return null;let i=u.value;s.timestamp+=e*i.getSeconds()*1e3}return[{type:"DATETIME",value:s}]};var h={suffix:["th","rd","st","nd"],month:["january","february","march","april","may","june","july","august","september","october","november","december"],era:["ad","bc"]},b={tokens:{DATETIME:{render:n=>{let{timestamp:t,offset:e}=n;return`${new Date(t+e*1e3).toISOString().slice(0,19).replace("T"," ")} ${e>0?"+":""}${e/3600}`}},DURATION:{render:n=>new c(n).render()}},rules:[{str:`
        n24: NUMBER[0-23]
        n60: NUMBER[0-59]
        ampm: I_AM | I_PM
        num_suffix: ${h.suffix.map(n=>`I_${n.toUpperCase()}`).join(" | ")}
        month: ${[...h.month.map(n=>`I_${n.toUpperCase()}`),...h.month.map(n=>`I_${n.slice(0,3).toUpperCase()}`),"NUMBER[1-12]"].join(" | ")}
        era: ${h.era.map(n=>`I_${n.toUpperCase()}`).join(" | ")}
        year: NUMBER[1-9999] era?
        date_sep: DIV | MINUS
        date_comp: year | month | NUMBER num_suffix?
        special_date: I_TODAY | I_TOMORROW | I_YESTERDAY | I_NOW

        n24 COLON n60 (COLON n60)? ampm? | n24 ampm -> time
        special_date -> date
        date_comp date_sep? date_comp date_sep? date_comp? -> date
        DATETIME DATETIME -> datetime
      `,before:"neg"},{str:`
        duration_unit: I_SECOND | I_SECONDS | I_SEC | I_SECS | I_SEC | I_MINUTE | I_MINUTES | I_MIN | I_MINS | I_M | I_HOUR | I_HOURS | I_HR | I_HRS | I_H | I_DAY | I_DAYS | I_WEEK | I_WEEKS | I_MONTH | I_MONTHS | I_YEAR | I_YEARS
        duration: NUMBER duration_unit

        duration+ (K_AND duration)? -> duration
        DURATION+ (K_AND DURATION)? (K_TO | K_AS | K_IN) duration_unit -> duration_convert
        DATETIME (PLUS | MINUS) DURATION+ -> date_op
        DATETIME MINUS DATETIME -> date_op
    `,after:"neg"}],action:function(n,t){return n==="date"?E(t,h):n==="time"?I(t):n==="datetime"?v(t):n==="duration"?D(t):n==="duration_convert"?U(t):n==="date_op"?y(t):null}};export{b as default};
